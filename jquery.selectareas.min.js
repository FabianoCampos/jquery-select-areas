!function(O){O.imageArea=function(t,i){var a,o,s,n,e,h=t.options,r=t.$image,c=t.$trigger,l={},d=!0,u=!0,g=[0,0],p=[0,0],f={id:i,x:0,y:0,z:0,height:0,width:0},m=function(){t.blurAll(),f.z=100,$()},w=function(e){r.trigger(e,[f.id,t.areas()])},v=function(e){var t=e||window.event||{};t.cancelBubble=!0,t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()},y=function(e,t){var i,a;switch(e){case"start":i="mousedown",a="touchstart";break;case"move":i="mousemove",a="touchmove";break;case"stop":i="mouseup",a="touchend";break;default:return}t&&jQuery.isFunction(t)?O(window.document).on(i,t).on(a,t):O(window.document).off(i).off(a)},x=function(){a.css({cursor:"default",width:f.width,height:f.height,left:f.x,top:f.y,"z-index":f.z}),o.css({backgroundPosition:-f.x-1+"px "+(-f.y-1)+"px",backgroundSize:r.width()+"px "+r.height()+"px",cursor:h.allowMove?"move":"default",width:0<f.width-2?f.width-2:0,height:0<f.height-2?f.height-2:0,left:f.x+1,top:f.y+1,"z-index":f.z+2})},S=function(e){h.allowResize&&(e?O.each(l,function(e,t){var i,a,o=Math.round(t.width()/2),s=Math.round(t.height()/2),n=e[0],h=e[e.length-1];i="n"===n?-s:"s"===n?f.height-s-1:Math.round(f.height/2)-s-1,a="e"===h?f.width-o-1:"w"===h?-o:Math.round(f.width/2)-o-1,t.css({display:"block",left:f.x+a,top:f.y+i,"z-index":f.z+1})}):O(".select-areas-resize-handler").each(function(){O(this).css({display:"none"})}))},A=function(e){s&&s.css({display:e?"block":"none",left:f.x+f.width+1,top:f.y-s.outerHeight()-1,"z-index":f.z+1})},b=function(e){if(n){var t=s?f.x+f.width-17:f.x+f.width+1;n.css({display:e?"block":"none",left:t,top:f.y-n.outerHeight()-1,"z-index":f.z+1})}},z=function(e){a.css({cursor:e}),o.css({cursor:e})},$=function(e){switch(e){case"startSelection":t._refresh(),x(),S(),A(!0),b(!0);break;case"pickSelection":case"pickResizeHandler":S();break;case"resizeSelection":x(),S(),z("crosshair"),A(!0),b(!0);break;case"moveSelection":x(),S(),z("move"),A(!0),b(!0);break;case"blur":x(),S(),A(),b();break;default:x(),S(!0),A(!0),b(!0)}},_=function(e){v(e),m(),y("move",R),y("stop",D);var t=E(e);g[0]=t[0]-f.x,g[1]=t[1]-f.y,$("pickSelection")},M=function(e){v(e),m();var t=e.target.className.split(" ")[1];"w"===t[t.length-1]&&(p[0]+=f.width,f.x=p[0]-f.width),"n"===t[0]&&(p[1]+=f.height,f.y=p[1]-f.height),"n"===t||"s"===t?d=!1:"e"!==t&&"w"!==t||(u=!1),y("move",k),y("stop",D),$("pickResizeHandler")},k=function(e){v(e),m();var t=E(e),i=t[1]-p[1],a=t[0]-p[0];Math.abs(a)<h.minSize[0]&&(a=0<=a?h.minSize[0]:-h.minSize[0]),Math.abs(i)<h.minSize[1]&&(i=0<=i?h.minSize[1]:-h.minSize[1]),(p[0]+a<0||p[0]+a>r.width())&&(a=-a),(p[1]+i<0||p[1]+i>r.height())&&(i=-i),h.maxSize[0]>h.minSize[0]&&h.maxSize[1]>h.minSize[1]&&(Math.abs(a)>h.maxSize[0]&&(a=0<=a?h.maxSize[0]:-h.maxSize[0]),Math.abs(i)>h.maxSize[1]&&(i=0<=i?h.maxSize[1]:-h.maxSize[1])),d&&(f.width=a),u&&(f.height=i),h.aspectRatio&&(0<a&&0<i||a<0&&i<0?d?i=Math.round(a/h.aspectRatio):a=Math.round(i*h.aspectRatio):d?i=-Math.round(a/h.aspectRatio):a=-Math.round(i*h.aspectRatio),p[0]+a>r.width()&&(a=r.width()-p[0],i=0<i?Math.round(a/h.aspectRatio):-Math.round(a/h.aspectRatio)),p[1]+i<0&&(i=-p[1],a=0<a?-Math.round(i*h.aspectRatio):Math.round(i*h.aspectRatio)),p[1]+i>r.height()&&(i=r.height()-p[1],a=0<a?Math.round(i*h.aspectRatio):-Math.round(i*h.aspectRatio)),f.width=a,f.height=i),f.width<0?(f.width=Math.abs(f.width),f.x=p[0]-f.width):f.x=p[0],f.height<0?(f.height=Math.abs(f.height),f.y=p[1]-f.height):f.y=p[1],w("changing"),$("resizeSelection")},R=function(e){if(v(e),h.allowMove){m();var t=E(e);C({x:t[0]-g[0],y:t[1]-g[1]}),w("changing")}},C=function(e){0<e.x?e.x+f.width<r.width()?f.x=e.x:f.x=r.width()-f.width:f.x=0,0<e.y?e.y+f.height<r.height()?f.y=e.y:f.y=r.height()-f.height:f.y=0,$("moveSelection")},D=function(e){v(e),function(){O.each(arguments,function(e,t){y(t)})}("move","stop"),p[0]=f.x,p[1]=f.y,u=d=!0,w("changed"),$("releaseSelection")},I=function(e){v(e),o.remove(),a.remove(),O.each(l,function(e,t){t.remove()}),s&&s.remove(),n&&n.remove(),t._remove(i),w("deleted")},j=function(e){v(e),w("cropped")},E=function(e){var t,i=[(t=O(r).offset()).left,t.top];e.pageX||(e.originalEvent&&(e=e.originalEvent),e.changedTouches&&(e=e.changedTouches[0]),e.touches&&(e=e.touches[0]));var a=e.pageX-i[0],o=e.pageY-i[1];return[a=a<0?0:a>r.width()?r.width():a,o=o<0?0:o>r.height()?r.height():o]};if(a=O('<div class="select-areas-outline" />').css({opacity:h.outlineOpacity,position:"absolute"}).insertAfter(c),o=O("<div />").addClass("select-areas-background-area").css({background:"#fff url("+r.attr("src")+") no-repeat",backgroundSize:r.width()+"px "+r.height()+"px",position:"absolute"}).insertAfter(a),h.allowResize&&O.each(["nw","n","ne","e","se","s","sw","w"],function(e,t){l[t]=O('<div class="select-areas-resize-handler '+t+'"/>').css({opacity:.5,position:"absolute",cursor:t+"-resize"}).insertAfter(o).mousedown(M).bind("touchstart",M)}),h.allowDelete){var H=function(e){return e.click(I).bind("touchstart",I).bind("tap",I),e};s=H(O('<div class="delete-area" />')).append(H(O('<div class="select-areas-delete-area" />'))).insertAfter(o)}if(h.allowCrop){n=(e=O('<div class="crop-area" />'),e.click(j),e).append(O('<div class="select-areas-crop-area" />')).insertAfter(o)}return h.allowMove&&o.mousedown(_).bind("touchstart",_),m(),{getData:function(){return f},startSelection:function(e){v(e),f.width=h.minSize[0],f.height=h.minSize[1],m(),y("move",k),y("stop",D),(p=E(e))[0]+f.width>r.width()&&(p[0]=r.width()-f.width),p[1]+f.height>r.height()&&(p[1]=r.height()-f.height),f.x=p[0],f.y=p[1],$("startSelection")},deleteSelection:I,cropSelection:j,options:h,blur:function(){f.z=0,$("blur")},focus:m,nudge:function(e){e.x=f.x,e.y=f.y,e.d&&(e.y=f.y+e.d),e.u&&(e.y=f.y-e.u),e.l&&(e.x=f.x-e.l),e.r&&(e.x=f.x+e.r),C(e),w("changed")},set:function(e,t){f=O.extend(f,e),p[0]=f.x,p[1]=f.y,t||w("changed")},contains:function(e){return e.x>=f.x&&e.x<=f.x+f.width&&e.y>=f.y&&e.y<=f.y+f.height}}},O.imageSelectAreas=function(){},O.imageSelectAreas.prototype.init=function(e,t){var o=this;this.options=O.extend({allowEdit:!0,allowMove:!0,allowResize:!0,allowSelect:!0,allowDelete:!0,allowCrop:!0,allowNudge:!0,aspectRatio:0,minSize:[0,0],maxSize:[0,0],width:0,maxAreas:0,outlineOpacity:.5,overlayOpacity:.5,areas:[],onChanging:null,onDeleted:null,onChanged:null,onCrop:null},t),this.options.allowEdit||(this.options.allowSelect=this.options.allowMove=this.options.allowResize=this.options.allowDelete=!1),this._areas={},this.$image=O(e),this.ratio=1,this.options.width&&this.$image.width()&&this.options.width!==this.$image.width()&&(this.ratio=this.options.width/this.$image.width(),this.$image.width(this.options.width)),this.options.onChanging&&this.$image.on("changing",this.options.onChanging),this.options.onChanged&&this.$image.on("changed",this.options.onChanged),this.options.onDeleted&&this.$image.on("deleted",this.options.onDeleted),this.options.onLoaded&&this.$image.on("loaded",this.options.onLoaded),this.options.onCrop&&this.$image.on("cropped",this.options.onCrop),this.$holder=O('<div class="select-areas-holder-wrap-image"/>').css({position:"relative",width:this.$image.width(),height:this.$image.height()}),this.$image.wrap(this.$holder).css({position:"absolute"}),this.$overlay=O('<div class="select-areas-overlay" />').css({opacity:this.options.overlayOpacity,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$image),this.$trigger=O("<div />").css({backgroundColor:"#000000",opacity:0,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$overlay),O.each(this.options.areas,function(e,t){o._add(t,!0)}),this.blurAll(),this._refresh(),this.options.allowSelect&&this.$trigger.mousedown(O.proxy(this.newArea,this)).on("touchstart",O.proxy(this.newArea,this)),this.options.allowNudge&&O("html").keydown(function(e){var t,i={37:"l",38:"u",39:"r",40:"d"}[e.which];if(i&&(o._eachArea(function(e){if(100===e.getData().z)return t=e,!1}),t)){var a={};a[i]=1,t.nudge(a)}})},O.imageSelectAreas.prototype._refresh=function(){var e=this.areas().length;this.$overlay.css({display:e?"block":"none"}),e?this.$image.addClass("blurred"):this.$image.removeClass("blurred"),this.$trigger.css({cursor:this.options.allowSelect?"crosshair":"default"})},O.imageSelectAreas.prototype.updateWidth=function(e){var t=e/this.$image.width();this.$image.width(e),this.$overlay.css({width:e,height:this.$image.height()}),this.$trigger.css({width:e,height:this.$image.height()}),this.$holder.css({width:e,height:this.$image.height()});var a=function(e){return e*t};this._eachArea(function(e,t){var i=O.extend({},e.getData());i.x=a(i.x),i.y=a(i.y),i.width=a(i.width),i.height=a(i.height),e.set(i,!0),e.blur()}),this.ratio=e/this.$image[0].naturalWidth},O.imageSelectAreas.prototype._eachArea=function(i){O.each(this._areas,function(e,t){if(t)return i(t,e)})},O.imageSelectAreas.prototype._remove=function(e){delete this._areas[e],this._refresh()},O.imageSelectAreas.prototype.remove=function(e){this._areas[e]&&this._areas[e].deleteSelection()},O.imageSelectAreas.prototype.newArea=function(e){var i=-1;return this.blurAll(),this.options.maxAreas&&this.options.maxAreas<=this.areas().length||(this._eachArea(function(e,t){i=Math.max(i,parseInt(t,10))}),i+=1,this._areas[i]=O.imageArea(this,i),e&&this._areas[i].startSelection(e)),i},O.imageSelectAreas.prototype.set=function(e,t,i){this._areas[e]&&(t.id=e,this._areas[e].set(t,i),this._areas[e].focus())},O.imageSelectAreas.prototype._add=function(e,t){var i=this.newArea();this.set(i,e,t)},O.imageSelectAreas.prototype.add=function(e){var i=this;this.blurAll(),O.isArray(e)?O.each(e,function(e,t){i._add(t)}):this._add(e),this._refresh(),this.options.allowSelect||this.options.allowMove||this.options.allowResize||this.options.allowDelete||this.blurAll()},O.imageSelectAreas.prototype.reset=function(){var i=this;this._eachArea(function(e,t){i.remove(t)}),this._refresh()},O.imageSelectAreas.prototype.destroy=function(){this.reset(),this.$holder.remove(),this.$overlay.remove(),this.$trigger.remove(),this.$image.css("width","").css("position","").unwrap(),this.$image.removeData("mainImageSelectAreas"),this.$image.off("changing changed loaded deleted cropped")},O.imageSelectAreas.prototype.areas=function(){var t=[];return this._eachArea(function(e){t.push(e.getData())}),t},O.imageSelectAreas.prototype.relativeAreas=function(){for(var e=this.areas(),t=[],i=this.ratio,a=function(e){return Math.floor(e/i)},o=0;o<e.length;o++)t[o]=O.extend({},e[o]),t[o].x=a(t[o].x),t[o].y=a(t[o].y),t[o].width=a(t[o].width),t[o].height=a(t[o].height);return t},O.imageSelectAreas.prototype.blurAll=function(){this._eachArea(function(e){e.blur()})},O.imageSelectAreas.prototype.contains=function(t){var i=!1;return this._eachArea(function(e){if(e.contains(t))return!(i=!0)}),i},O.selectAreas=function(e,t){var i=O(e);if(!i.data("mainImageSelectAreas")){var a=new O.imageSelectAreas;a.init(e,t),i.data("mainImageSelectAreas",a),i.trigger("loaded")}return i.data("mainImageSelectAreas")},O.fn.selectAreas=function(i){if(O.imageSelectAreas.prototype[i]){var e=O.imageSelectAreas.prototype[i].apply(O.selectAreas(this),Array.prototype.slice.call(arguments,1));return void 0===e?this:e}if("object"==typeof i||!i)return this.each(function(){var e=this,t=new Image;t.onload=function(){O.selectAreas(e,i)},t.src=e.src}),this;O.error("Method "+i+" does not exist on jQuery.selectAreas")}}(jQuery);